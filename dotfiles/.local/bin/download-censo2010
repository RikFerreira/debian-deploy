#!/bin/sh

# Formatting output
BOLD=$(tput bold)
REGULAR=$(tput sgr0)

RED='\033[0;31m'
BLUE='\033[0;34m'
NOCOLOR='\033[0m'

# Working directory
tempdir="$HOME/.census_microdata"
[ -d $tempdir ] && rm -rf $tempdir
mkdir -p $tempdir

# SQLite output
[ -z $1 ] && database="$HOME/censo.db" || database="$1"
[ -f $database ] && printf "${RED}${BOLD}---> $database already exists.${NOCOLOR}\n" && rm -r $tempdir && exit 0

printf "${BLUE}${BOLD}---> The $tempdir will be removed after the script. The output is $database, a sqlite database.${NOCOLOR}\n\n"

printf "${BLUE}${BOLD}---> Recovering files from FTP server.${NOCOLOR}\n\n"

ftp_dir="ftp://ftp.ibge.gov.br/Censos/Censo_Demografico_2010/Resultados_Gerais_da_Amostra/Microdados/"
ftp_files="$(curl "$ftp_dir" | awk -v dir=$ftp_dir '{print dir $9}' | sed -n -e '/\.zip$/p' | sed '/Documentacao.zip$/d')"

printf "${BLUE}${BOLD}\n---> Downloading zipfiles from FTP server.${NOCOLOR}\n\n"

for file in $ftp_files; do
    wget --directory-prefix="$tempdir" "$file"
done

printf "${BLUE}${BOLD}---> Unzipping files.${NOCOLOR}\n\n"

files="$(echo "$ftp_files" | sed -n -e 's/.*\///p' | awk -v dir=$tempdir '{print dir"/"$1}')"

for i in $files; do
    unzip $i -d $tempdir
done

# DOMICILIOS
printf "${BLUE}${BOLD}---> Processing DOMICILIOS.${NOCOLOR}\n\n"

sqlite3 $database "CREATE TABLE domicilios(
	V0001 TEXT,
	V0002 TEXT,
	V0011 TEXT,
	V0300 REAL,
	V0010 REAL,
	V1001 TEXT,
	V1002 TEXT,
	V1003 TEXT,
	V1004 TEXT,
	V1006 TEXT,
	V4001 TEXT,
	V4002 TEXT,
	V0201 TEXT,
	V2011 REAL,
	V2012 REAL,
	V0202 TEXT,
	V0203 REAL,
	V6203 REAL,
	V0204 REAL,
	V6204 REAL,
	V0205 TEXT,
	V0206 TEXT,
	V0207 TEXT,
	V0208 TEXT,
	V0209 TEXT,
	V0210 TEXT,
	V0211 TEXT,
	V0212 TEXT,
	V0213 TEXT,
	V0214 TEXT,
	V0215 TEXT,
	V0216 TEXT,
	V0217 TEXT,
	V0218 TEXT,
	V0219 TEXT,
	V0220 TEXT,
	V0221 TEXT,
	V0222 TEXT,
	V0301 TEXT,
	V0401 REAL,
	V0402 TEXT,
	V0701 TEXT,
	V6529 REAL,
	V6530 REAL,
	V6531 REAL,
	V6532 REAL,
	V6600 TEXT,
	V6210 TEXT,
	M0201 TEXT,
	M2011 TEXT,
	M0202 TEXT,
	M0203 TEXT,
	M0204 TEXT,
	M0205 TEXT,
	M0206 TEXT,
	M0207 TEXT,
	M0208 TEXT,
	M0209 TEXT,
	M0210 TEXT,
	M0211 TEXT,
	M0212 TEXT,
	M0213 TEXT,
	M0214 TEXT,
	M0215 TEXT,
	M0216 TEXT,
	M0217 TEXT,
	M0218 TEXT,
	M0219 TEXT,
	M0220 TEXT,
	M0221 TEXT,
	M0222 TEXT,
	M0301 TEXT,
	M0401 TEXT,
	M0402 TEXT,
	M0701 TEXT,
	V1005 TEXT
);"

for file in "$(find $tempdir -name "Amostra_Domicilios_*")"; do
    awk -v OFS="," -v FIELDWIDTHS="2 5 13 8 16 1 2 3 2 1 2 2 1 6 9 1 2 3 2 3 1 1 1 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 1 1 7 10 8 9 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1" '{print $1,$2,$3,$4,$5=substr($5, 1, 3)"."substr($5, 4, 10),$6,$7,$8,$9,$10,$11,$12,$13,$14,$15=substr($15, 1, 4)"."substr($15, 5, 5),$16,$17,$18=substr($18, 1, 2)"."substr($18, 3, 1),$19,$20=substr($20, 1, 2)"."substr($20, 3, 1),$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44=substr($44, 1, 5)"."substr($44, 6, 5),$45=substr($45, 1, 6)"."substr($45, 7, 2),$46=substr($46, 1, 4)"."substr($46, 5, 5),$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76}' $file | sed -e 's/ //g' -e 's/,\.,/,,/g' | sqlite3 $database ".import --csv /dev/stdin domicilios"
done

# PESSOAS
printf "${BLUE}${BOLD}---> Processing PESSOAS.${NOCOLOR}\n\n"

sqlite3 $database "CREATE TABLE pessoas(
	V0001 TEXT,
	V0002 TEXT,
	V0011 TEXT,
	V0300 REAL,
	V0010 REAL,
	V1001 TEXT,
	V1002 TEXT,
	V1003 TEXT,
	V1004 TEXT,
	V1006 TEXT,
	V0502 TEXT,
	V0504 TEXT,
	V0601 TEXT,
	V6033 REAL,
	V6036 REAL,
	V6037 REAL,
	V6040 TEXT,
	V0606 TEXT,
	V0613 TEXT,
	V0614 TEXT,
	V0615 TEXT,
	V0616 TEXT,
	V0617 TEXT,
	V0618 TEXT,
	V0619 TEXT,
	V0620 TEXT,
	V0621 TEXT,
	V0622 TEXT,
	V6222 TEXT,
	V6224 TEXT,
	V0623 TEXT,
	V0624 TEXT,
	V0625 TEXT,
	V6252 TEXT,
	V6254 TEXT,
	V6256 TEXT,
	V0626 TEXT,
	V6262 TEXT,
	V6264 TEXT,
	V6266 TEXT,
	V0627 TEXT,
	V0628 TEXT,
	V0629 TEXT,
	V0630 TEXT,
	V0631 TEXT,
	V0632 TEXT,
	V0633 TEXT,
	V0634 TEXT,
	V0635 TEXT,
	V6400 TEXT,
	V6352 TEXT,
	V6354 TEXT,
	V6356 TEXT,
	V0636 TEXT,
	V6362 TEXT,
	V6364 TEXT,
	V6366 TEXT,
	V0637 TEXT,
	V0638 TEXT,
	V0639 TEXT,
	V0640 TEXT,
	V0641 TEXT,
	V0642 TEXT,
	V0643 TEXT,
	V0644 TEXT,
	V0645 TEXT,
	V6461 TEXT,
	V6471 TEXT,
	V0648 TEXT,
	V0649 TEXT,
	V0650 TEXT,
	V0651 TEXT,
	V6511 REAL,
	V6513 REAL,
	V6514 REAL,
	V0652 TEXT,
	V6521 REAL,
	V6524 REAL,
	V6525 REAL,
	V6526 REAL,
	V6527 REAL,
	V6528 REAL,
	V6529 REAL,
	V6530 REAL,
	V6531 REAL,
	V6532 REAL,
	V0653 REAL,
	V0654 TEXT,
	V0655 TEXT,
	V0656 TEXT,
	V0657 TEXT,
	V0658 TEXT,
	V0659 TEXT,
	V6591 REAL,
	V0660 TEXT,
	V6602 TEXT,
	V6604 TEXT,
	V6606 TEXT,
	V0661 TEXT,
	V0662 TEXT,
	V0663 TEXT,
	V6631 REAL,
	V6632 REAL,
	V6633 REAL,
	V0664 TEXT,
	V6641 REAL,
	V6642 REAL,
	V6643 REAL,
	V0665 TEXT,
	V6660 REAL,
	V6664 TEXT,
	V0667 TEXT,
	V0668 TEXT,
	V6681 TEXT,
	V6682 TEXT,
	V0669 TEXT,
	V6691 REAL,
	V6692 REAL,
	V6693 REAL,
	V6800 REAL,
	V0670 TEXT,
	V0671 TEXT,
	V6900 TEXT,
	V6910 TEXT,
	V6920 TEXT,
	V6930 TEXT,
	V6940 TEXT,
	V6121 TEXT,
	V0604 TEXT,
	V0605 TEXT,
	V5020 TEXT,
	V5060 REAL,
	V5070 REAL,
	V5080 REAL,
	V6462 TEXT,
	V6472 TEXT,
	V5110 TEXT,
	V5120 TEXT,
	V5030 TEXT,
	V5040 TEXT,
	V5090 TEXT,
	V5100 TEXT,
	V5130 TEXT,
	M0502 TEXT,
	M0601 TEXT,
	M6033 TEXT,
	M0606 TEXT,
	M0613 TEXT,
	M0614 TEXT,
	M0615 TEXT,
	M0616 TEXT,
	M0617 TEXT,
	M0618 TEXT,
	M0619 TEXT,
	M0620 TEXT,
	M0621 TEXT,
	M0622 TEXT,
	M6222 TEXT,
	M6224 TEXT,
	M0623 TEXT,
	M0624 TEXT,
	M0625 TEXT,
	M6252 TEXT,
	M6254 TEXT,
	M6256 TEXT,
	M0626 TEXT,
	M6262 TEXT,
	M6264 TEXT,
	M6266 TEXT,
	M0627 TEXT,
	M0628 TEXT,
	M0629 TEXT,
	M0630 TEXT,
	M0631 TEXT,
	M0632 TEXT,
	M0633 TEXT,
	M0634 TEXT,
	M0635 TEXT,
	M6352 TEXT,
	M6354 TEXT,
	M6356 TEXT,
	M0636 TEXT,
	M6362 TEXT,
	M6364 TEXT,
	M6366 TEXT,
	M0637 TEXT,
	M0638 TEXT,
	M0639 TEXT,
	M0640 TEXT,
	M0641 TEXT,
	M0642 TEXT,
	M0643 TEXT,
	M0644 TEXT,
	M0645 TEXT,
	M6461 TEXT,
	M6471 TEXT,
	M0648 TEXT,
	M0649 TEXT,
	M0650 TEXT,
	M0651 TEXT,
	M6511 TEXT,
	M0652 TEXT,
	M6521 TEXT,
	M0653 TEXT,
	M0654 TEXT,
	M0655 TEXT,
	M0656 TEXT,
	M0657 TEXT,
	M0658 TEXT,
	M0659 TEXT,
	M6591 TEXT,
	M0660 TEXT,
	M6602 TEXT,
	M6604 TEXT,
	M6606 TEXT,
	M0661 TEXT,
	M0662 TEXT,
	M0663 TEXT,
	M6631 TEXT,
	M6632 TEXT,
	M6633 TEXT,
	M0664 TEXT,
	M6641 TEXT,
	M6642 TEXT,
	M6643 TEXT,
	M0665 TEXT,
	M6660 TEXT,
	M0667 TEXT,
	M0668 TEXT,
	M6681 TEXT,
	M6682 TEXT,
	M0669 TEXT,
	M6691 TEXT,
	M6692 TEXT,
	M6693 TEXT,
	M0670 TEXT,
	M0671 TEXT,
	M6800 TEXT,
	M6121 TEXT,
	M0604 TEXT,
	M0605 TEXT,
	M6462 TEXT,
	M6472 TEXT,
	V1005 TEXT
);"

for file in "$(find $tempdir -name "Amostra_Pessoas_*")"; do
    awk -v OFS="," -v FIELDWIDTHS="2 5 13 8 16 1 2 3 2 1 2 2 1 3 3 2 1 1 1 1 1 1 1 1 1 1 4 1 7 7 3 3 1 7 7 7 1 7 7 7 1 1 2 2 1 1 2 1 1 1 3 3 3 1 7 7 7 1 2 1 1 1 1 1 1 1 4 5 1 1 1 1 6 6 6 1 6 9 7 9 7 9 7 10 8 9 3 1 1 1 1 1 1 6 1 7 7 7 1 1 1 2 2 2 1 2 2 2 1 3 1 1 1 2 4 1 2 2 2 2 1 2 1 1 1 1 1 3 1 2 2 2 8 9 4 5 1 1 1 1 1 1 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1" '{print $1,$2,$3,$4,$5=substr($5, 1, 3)"."substr($5, 4, 10),$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75=substr($75, 1, 4)"."substr($75, 5, 2),$76,$77,$78=substr($78, 1, 4)"."substr($78, 5, 5),$79,$80=substr($80, 1, 4)"."substr($80, 5, 5),$81,$82=substr($82, 1, 4)"."substr($82, 5, 5),$83,$84=substr($84, 1, 5)"."substr($84, 6, 5),$85=substr($85, 1, 6)"."substr($85, 7, 2),$86=substr($86, 1, 4)"."substr($86, 5, 5),$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133=substr($133, 1, 6)"."substr($133, 7, 2),$134=substr($134, 1, 4)"."substr($134, 5, 5),$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244}' $file | sed -e 's/ //g' -e 's/,\.,/,,/g' | sqlite3 $database ".import --csv /dev/stdin pessoas"
done

# EMIGRACAO
printf "${BLUE}${BOLD}---> Processing EMIGRACAO.${NOCOLOR}\n\n"

sqlite3 $database "CREATE TABLE emigracao(
	V0001 TEXT,
	V0002 TEXT,
	V0011 TEXT,
	V0300 REAL,
	V0010 REAL,
	V1001 TEXT,
	V1002 TEXT,
	V1003 TEXT,
	V1004 TEXT,
	V1006 TEXT,
	V0303 TEXT,
	V0304 TEXT,
	V0305 TEXT,
	V3061 TEXT,
	M0303 TEXT,
	M0304 TEXT,
	M0305 TEXT,
	M3061 TEXT,
	V1005 TEXT
);"

for file in "$(find $tempdir -name "Amostra_Emigracao_*")"; do
    awk -v OFS="," -v FIELDWIDTHS="2 5 13 8 16 1 2 3 2 1 1 4 4 7 1 1 1 1 1" '{print $1,$2,$3,$4,$5=substr($5, 1, 3)"."substr($5, 4, 10),$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19}' $file | sed -e 's/ //g' -e 's/,\.,/,,/g' | sqlite3 $database ".import --csv /dev/stdin emigracao"
done

# MORTALIDADE
printf "${BLUE}${BOLD}---> Processing MORTALIDADE.${NOCOLOR}\n\n"

sqlite3 $database "CREATE TABLE mortalidade(
	V0001 TEXT,
	V0002 TEXT,
	V0011 TEXT,
	V0300 REAL,
	V0010 REAL,
	V1001 TEXT,
	V1002 TEXT,
	V1003 TEXT,
	V1004 TEXT,
	V1006 TEXT,
	V0703 TEXT,
	V0704 TEXT,
	V7051 REAL,
	V7052 REAL,
	M0703 TEXT,
	M0704 TEXT,
	M7051 TEXT,
	M7052 TEXT,
	V1005 TEXT
);"

for file in "$(find $tempdir -name "Amostra_Mortalidade_*")"; do
    awk -v OFS="," -v FIELDWIDTHS="2 5 13 8 16 1 2 3 2 1 2 1 3 2 1 1 1 1 1" '{print $1,$2,$3,$4,$5=substr($5, 1, 3)"."substr($5, 4, 10),$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19}' $file | sed -e 's/ //g' -e 's/,\.,/,,/g' | sqlite3 $database ".import --csv /dev/stdin mortalidade"
done

rm -rf $tempdir
